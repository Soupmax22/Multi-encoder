<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Multi-layer Encoder/Decoder</title>
<style>
body{margin:0;font-family:Arial;background:#0f1724;color:#e6eef6}
.wrap{max-width:900px;margin:20px auto;padding:20px;background:#0b1220;border-radius:10px;}
textarea{width:100%;height:120px;margin:5px 0;padding:10px;background:#061124;color:inherit;border-radius:6px;border:none;font-family:monospace;}
button,select,input{margin:3px;padding:5px;border-radius:6px;background:#132034;color:#e6eef6;border:none;cursor:pointer;}
.layer-row{display:flex;justify-content:space-between;background:#111b2b;padding:4px;margin:2px 0;border-radius:4px;}
.pill{background:#132034;padding:2px 8px;border-radius:999px;font-size:12px;}
</style>
</head>
<body>
<div class="wrap">
<h2>Multi-layer Encoder/Decoder</h2>
<textarea id="input" placeholder="Input text here..."></textarea>
<div>
<select id="layer-select">
  <option value="url">URL Encode</option>
  <option value="base64">Base64</option>
  <option value="hex">Hex</option>
  <option value="rot13">ROT13</option>
  <option value="caesar">Caesar</option>
  <option value="reverse">Reverse</option>
  <option value="base85">Base85</option>
</select>
<input type="number" id="caesar-shift" value="13" style="width:50px;display:none;">
<button id="add-layer">Add Layer</button>
<button id="clear-layers">Clear Layers</button>
<span class="pill" id="layer-count">Layers: 0</span>
</div>
<div id="layers"></div>
<div>
<button id="encode-btn">Encode</button>
<button id="decode-btn">Decode</button>
<button id="copy-btn">Copy Output</button>
<button id="save-btn">Save as .txt</button>
</div>
<textarea id="output" readonly placeholder="Output appears here..."></textarea>
<div>
<h4>Presets</h4>
<button id="preset1">URL → Base64 → Hex</button>
<button id="preset2">ROT13 → Caesar(5)</button>
<button id="preset3">Base64 → Base85</button>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const layers=[];
const layersDiv=document.getElementById("layers");
const layerCount=document.getElementById("layer-count");
const caesarShift=document.getElementById("caesar-shift");

function renderLayers(){
  layersDiv.innerHTML="";
  layers.forEach((l,i)=>{
    const row=document.createElement("div"); row.className="layer-row";
    row.innerHTML=`<span>${l.type}${l.params.shift?`(shift=${l.params.shift})`:""}</span>
      <span>
      <button onclick="moveUp(${i})">↑</button>
      <button onclick="moveDown(${i})">↓</button>
      <button onclick="removeLayer(${i})">✕</button>
      </span>`;
    layersDiv.appendChild(row);
  });
  layerCount.textContent="Layers: "+layers.length;
}

window.addLayer=(t,p={})=>{layers.push({type:t,params:p}); renderLayers();}
window.removeLayer=(i)=>{layers.splice(i,1);renderLayers();}
window.moveUp=(i)=>{if(i>0){[layers[i-1],layers[i]]=[layers[i],layers[i-1]];renderLayers();}}
window.moveDown=(i)=>{if(i<layers.length-1){[layers[i],layers[i+1]]=[layers[i+1],layers[i]];renderLayers()}}

document.getElementById("layer-select").addEventListener("change",(e)=>{
  caesarShift.style.display=e.target.value==="caesar"?"inline-block":"none";
});

document.getElementById("add-layer").addEventListener("click",()=>{
  const type=document.getElementById("layer-select").value;
  const params={};
  if(type==="caesar") params.shift=parseInt(caesarShift.value)||13;
  addLayer(type,params);
});

document.getElementById("clear-layers").addEventListener("click",()=>{layers.length=0;renderLayers();});

// Basic encoders
function encodeBase64(str){return btoa(unescape(encodeURIComponent(str)));}
function decodeBase64(str){return decodeURIComponent(escape(atob(str)));}
function encodeHex(str){return Array.from(unescape(encodeURIComponent(str))).map(c=>c.charCodeAt(0).toString(16).padStart(2,'0')).join('');}
function decodeHex(str){let res=[];for(let i=0;i<str.length;i+=2) res.push(String.fromCharCode(parseInt(str.substr(i,2),16))); return decodeURIComponent(escape(res.join('')));}
function rot13(str){return str.replace(/[A-Za-z]/g,c=>{let b=c<='Z'?65:97; return String.fromCharCode((c.charCodeAt(0)-b+13)%26+b);});}
function caesar(str,shift){return str.replace(/[A-Za-z]/g,c=>{let b=c<='Z'?65:97; return String.fromCharCode((c.charCodeAt(0)-b+shift+26)%26+b);});}
function reverseStr(str){return str.split('').reverse().join('');}

// Base85 (ASCII85)
function base85Encode(str){
  const bytes=new TextEncoder().encode(str);
  let pad=(4-bytes.length%4)%4;
  const arr=new Uint8Array(bytes.length+pad);
  arr.set(bytes);
  let out="";
  for(let i=0;i<arr.length;i+=4){
    let num=(arr[i]<<24)|(arr[i+1]<<16)|(arr[i+2]<<8)|arr[i+3];
    let chunk="";
    for(let j=0;j<5;j++){chunk=String.fromCharCode(num%85+33)+chunk; num=Math.floor(num/85);}
    out+=chunk;
  }
  return out.substr(0,out.length-(pad?5:0));
}
function base85Decode(str){
  if(str.length%5) throw new Error("Bad Base85 length");
  let out=[];
  for(let i=0;i<str.length;i+=5){
    let num=0;
    for(let j=0;j<5;j++) num=num*85+(str.charCodeAt(i+j)-33);
    for(let j=3;j>=0;j--) out.push((num>>(8*j))&255);
  }
  return new TextDecoder().decode(new Uint8Array(out));
}

function applyEncode(str,l){
  switch(l.type){
    case"url": return encodeURIComponent(str);
    case"base64": return encodeBase64(str);
    case"hex": return encodeHex(str);
    case"rot13": return rot13(str);
    case"caesar": return caesar(str,l.params.shift||13);
    case"reverse": return reverseStr(str);
    case"base85": return base85Encode(str);
  }
}
function applyDecode(str,l){
  switch(l.type){
    case"url": return decodeURIComponent(str);
    case"base64": return decodeBase64(str);
    case"hex": return decodeHex(str);
    case"rot13": return rot13(str);
    case"caesar": return caesar(str,-(l.params.shift||13));
    case"reverse": return reverseStr(str);
    case"base85": return base85Decode(str);
  }
}

const input=document.getElementById("input");
const output=document.getElementById("output");

document.getElementById("encode-btn").addEventListener("click",()=>{
  try{let txt=input.value; layers.forEach(l=>txt=applyEncode(txt,l)); output.value=txt;}
  catch(e){alert(e.message);}
});
document.getElementById("decode-btn").addEventListener("click",()=>{
  try{let txt=input.value; for(let i=layers.length-1;i>=0;i--) txt=applyDecode(txt,layers[i]); output.value=txt;}
  catch(e){alert(e.message);}
});
document.getElementById("copy-btn").addEventListener("click",()=>{navigator.clipboard.writeText(output.value);});
document.getElementById("save-btn").addEventListener("click",()=>{
  const blob=new Blob([output.value],{type:"text/plain"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="output.txt"; a.click();
});

// Presets
document.getElementById("preset1").addEventListener("click",()=>{layers.length=0; addLayer("url"); addLayer("base64"); addLayer("hex");});
document.getElementById("preset2").addEventListener("click",()=>{layers.length=0; addLayer("rot13"); addLayer("caesar",{shift:5});});
document.getElementById("preset3").addEventListener("click",()=>{layers.length=0; addLayer("base64"); addLayer("base85");});

renderLayers();
});
</script>
</body>
</html>
